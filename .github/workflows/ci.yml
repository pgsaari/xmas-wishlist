name: CI

on:
  push:
    branches: [ main, 'feature/**', 'fix/**' ]
  pull_request:
    # Run on all pull requests (created, updated, synchronize)
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Install all dependencies
      run: npm run install:all

    - name: Build backend
      run: cd backend && npm run build
      continue-on-error: false

    - name: Build frontend
      run: cd frontend && npm run build
      continue-on-error: false

  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for better coverage comparison

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Install all dependencies
      run: npm run install:all

    - name: Verify coverage provider is installed
      run: |
        cd frontend
        if npm list @vitest/coverage-v8 > /dev/null 2>&1; then
          echo "‚úÖ @vitest/coverage-v8 is installed"
        else
          echo "‚ùå @vitest/coverage-v8 is NOT installed - installing now..."
          npm install --save-dev @vitest/coverage-v8
        fi

    - name: Run frontend tests with coverage
      run: cd frontend && npm run test:coverage
      continue-on-error: false
      
    - name: Verify coverage files were generated
      if: always()
      run: |
        echo "Checking for coverage files..."
        if [ -d "frontend/coverage" ]; then
          echo "‚úÖ Coverage directory exists"
          echo "Files in coverage directory:"
          ls -la frontend/coverage/ || true
        else
          echo "‚ö†Ô∏è Coverage directory was not created"
        fi
        if [ -f "frontend/coverage/coverage-summary.json" ]; then
          echo "‚úÖ coverage-summary.json exists"
          echo "File size: $(wc -c < frontend/coverage/coverage-summary.json) bytes"
        else
          echo "‚ùå coverage-summary.json not found"
        fi

    - name: Parse coverage and comment on PR
      if: github.event_name == 'pull_request'
      continue-on-error: true
      uses: actions/github-script@v7
      env:
        COVERAGE_FILE: frontend/coverage/coverage-summary.json
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          console.log('üîç Starting coverage comment step...');
          console.log('Current working directory:', process.cwd());
          console.log('Coverage file path:', process.env.COVERAGE_FILE);
          
          // Read coverage summary
          const coveragePath = path.join(process.cwd(), process.env.COVERAGE_FILE);
          console.log('Full coverage path:', coveragePath);
          
          // Check if coverage directory exists
          const coverageDir = path.dirname(coveragePath);
          if (fs.existsSync(coverageDir)) {
            console.log('Coverage directory exists');
            console.log('Files in coverage directory:', fs.readdirSync(coverageDir));
          } else {
            console.log('‚ö†Ô∏è Coverage directory does not exist:', coverageDir);
          }
          
          if (!fs.existsSync(coveragePath)) {
            console.log(`‚ö†Ô∏è Coverage file not found at: ${coveragePath}`);
            console.log('This is not a critical error - tests passed, but coverage report is missing.');
            console.log('Coverage comment will be skipped.');
            // Don't fail the step - tests already passed
            process.exit(0);
          }
          
          console.log('‚úÖ Coverage file found!');
          
          let coverage;
          try {
            coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
          } catch (error) {
            console.error('‚ùå Error parsing coverage file:', error.message);
            console.log('Coverage comment will be skipped.');
            process.exit(0);
          }
          
          // Calculate totals - handle both possible structures
          const total = coverage.total || coverage;
          if (!total || !total.lines) {
            console.error('‚ùå Unexpected coverage file structure');
            console.log('Coverage comment will be skipped.');
            process.exit(0);
          }
          
          const lines = total.lines?.pct ?? 0;
          const statements = total.statements?.pct ?? 0;
          const functions = total.functions?.pct ?? 0;
          const branches = total.branches?.pct ?? 0;
          
          // Determine coverage status emoji
          const getStatusEmoji = (pct) => {
            if (pct >= 80) return 'üü¢';
            if (pct >= 60) return 'üü°';
            return 'üî¥';
          };
          
          // Create coverage comment with better formatting
          const comment = `## üìä Test Coverage Report
          
          | Metric | Coverage | Status |
          |--------|----------|--------|
          | **Lines** | ${lines.toFixed(2)}% | ${getStatusEmoji(lines)} |
          | **Statements** | ${statements.toFixed(2)}% | ${getStatusEmoji(statements)} |
          | **Functions** | ${functions.toFixed(2)}% | ${getStatusEmoji(functions)} |
          | **Branches** | ${branches.toFixed(2)}% | ${getStatusEmoji(branches)} |
          
          **Total Coverage**: ${lines.toFixed(2)}%
          
          > Coverage report generated by [Vitest](https://vitest.dev/) with [@vitest/coverage-v8](https://github.com/vitest-dev/vitest/tree/main/packages/coverage-v8)
          
          ---
          *This comment will be updated automatically when new commits are pushed to this PR.*`;
          
          try {
            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('üìä Test Coverage Report') || comment.body.includes('Test Coverage Report'))
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
              console.log('‚úÖ Coverage comment updated successfully');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
              console.log('‚úÖ Coverage comment posted successfully');
            }
          } catch (error) {
            console.error('‚ùå Error posting coverage comment:', error.message);
            console.log('This is not a critical error - tests passed successfully.');
            // Don't fail the workflow if commenting fails
            process.exit(0);
          }

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          frontend/coverage/
        retention-days: 7

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Install all dependencies
      run: npm run install:all

    - name: Run linter (if configured)
      run: echo "Add linting commands here when configured"
      continue-on-error: true

